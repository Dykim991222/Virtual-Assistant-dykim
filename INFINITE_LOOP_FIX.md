# ë¬´í•œ ë£¨í”„ ë¬¸ì œ í•´ê²°

## ë¬¸ì œ ì¦ìƒ
ë¡œê·¸ì¸ â†’ ê¶Œí•œ ì„¤ì • â†’ ë¡œê·¸ì¸ â†’ ê¶Œí•œ ì„¤ì • ë¬´í•œ ë£¨í”„ ë°œìƒ

## ì›ì¸ ë¶„ì„

### 1. Google OAuth `prompt="consent"` ì„¤ì •
- `backend/app/infrastructure/oauth/google.py`ì˜ 41ë²ˆ ì¤„ì—ì„œ `prompt="consent"` ì„¤ì •
- ì´ ì„¤ì •ì€ **ë§¤ë²ˆ ê¶Œí•œ ìŠ¹ì¸ í™”ë©´ì„ í‘œì‹œ**í•˜ë„ë¡ ê°•ì œí•¨
- ë¡œê·¸ì¸í•  ë•Œë§ˆë‹¤ ê¶Œí•œ ì„¤ì • í™”ë©´ì´ ë‚˜íƒ€ë‚˜ëŠ” ì›ì¸

### 2. ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì¿ í‚¤ ì‚­ì œ
- `frontend/Login/script.js`ì—ì„œ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ `logout(false)` í˜¸ì¶œ
- ì´ë¯¸ ì„¤ì •ëœ ì¿ í‚¤ë¥¼ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ë¡œê·¸ì¸ ì‹œë„
- ë¶ˆí•„ìš”í•œ ë¡œê·¸ì•„ì›ƒ ë™ì‘

### 3. ì¿ í‚¤ ê²½ë¡œ ì„¤ì • ëˆ„ë½
- ì¿ í‚¤ ì„¤ì • ì‹œ `path="/"` ì„¤ì •ì´ ëˆ„ë½ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŒ
- ì¿ í‚¤ê°€ íŠ¹ì • ê²½ë¡œì—ì„œë§Œ ìœ íš¨í•  ìˆ˜ ìˆìŒ

## í•´ê²° ë°©ë²•

### 1. `prompt` ì„¤ì • ë³€ê²½
**íŒŒì¼**: `backend/app/infrastructure/oauth/google.py`

**ë³€ê²½ ì „**:
```python
prompt="consent",  # ë§¤ë²ˆ ê¶Œí•œ ìŠ¹ì¸ ìš”ì²­
```

**ë³€ê²½ í›„**:
```python
prompt="select_account",  # ê³„ì • ì„ íƒ í™”ë©´ë§Œ í‘œì‹œ
```

**íš¨ê³¼**:
- ì²« ë¡œê·¸ì¸ ì‹œì—ë§Œ ê¶Œí•œ ìŠ¹ì¸ ìš”ì²­
- ì´í›„ ë¡œê·¸ì¸ ì‹œì—ëŠ” ê³„ì • ì„ íƒë§Œ í‘œì‹œ
- ê¶Œí•œ ì„¤ì • ë¬´í•œ ë£¨í”„ í•´ê²°

### 2. ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ ì¿ í‚¤ ì‚­ì œ ì œê±°
**íŒŒì¼**: `frontend/Login/script.js`

**ë³€ê²½ ì „**:
```javascript
async function loginWithGoogle() {
    try {
        // ê¸°ì¡´ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ (ê°•ì œ ë¡œê·¸ì•„ì›ƒ)
        logout(false);
        // ...
    }
}
```

**ë³€ê²½ í›„**:
```javascript
async function loginWithGoogle() {
    try {
        console.log('ğŸ”µ Google ë¡œê·¸ì¸ ì‹œì‘');
        // logout(false) ì œê±°
        // ...
    }
}
```

**íš¨ê³¼**:
- ë¶ˆí•„ìš”í•œ ì¿ í‚¤ ì‚­ì œ ë°©ì§€
- ë¡œê·¸ì¸ í”Œë¡œìš° ê°„ì†Œí™”

### 3. ì¿ í‚¤ ê²½ë¡œ ëª…ì‹œì  ì„¤ì •
**íŒŒì¼**: `backend/app/api/v1/endpoints/auth.py`

**ì¶”ê°€**:
```python
response.set_cookie(
    key="access_token",
    value=result.access_token,
    httponly=True,
    secure=not settings.DEBUG,
    samesite="lax",
    max_age=settings.ACCESS_TOKEN_EXPIRE_MINUTES * 60,
    path="/"  # ëª¨ë“  ê²½ë¡œì—ì„œ ì¿ í‚¤ ì‚¬ìš© ê°€ëŠ¥
)
```

**íš¨ê³¼**:
- ëª¨ë“  ê²½ë¡œì—ì„œ ì¿ í‚¤ ì ‘ê·¼ ê°€ëŠ¥
- `/login`, `/start` ë“± ëª¨ë“  í˜ì´ì§€ì—ì„œ ì¿ í‚¤ ì½ê¸° ê°€ëŠ¥

### 4. ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
**íŒŒì¼**: `frontend/Login/script.js`, `backend/app/api/v1/endpoints/auth.py`

**ì¶”ê°€ëœ ë¡œê·¸**:
- í˜ì´ì§€ ë¡œë“œ ì‹œ ì¿ í‚¤ ìƒíƒœ ì¶œë ¥
- ë¡œê·¸ì¸ ì‹œì‘/ì™„ë£Œ ë¡œê·¸
- ì¿ í‚¤ ì„¤ì • ì™„ë£Œ ë¡œê·¸
- ë¦¬ë‹¤ì´ë ‰íŠ¸ ë¡œê·¸

**íš¨ê³¼**:
- ë¬¸ì œ ë°œìƒ ì‹œ ì›ì¸ íŒŒì•… ìš©ì´
- ë¡œê·¸ì¸ í”Œë¡œìš° ì¶”ì  ê°€ëŠ¥

## í…ŒìŠ¤íŠ¸ ë°©ë²•

1. ë°±ì—”ë“œ ì¬ì‹œì‘:
```bash
cd backend
uvicorn app.main:app --reload
```

2. ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ > Console ì—´ê¸°

3. ë¡œê·¸ì¸ ì‹œë„:
   - `http://localhost:8000/login` ì ‘ì†
   - Google/Kakao/Naver ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
   - ì½˜ì†” ë¡œê·¸ í™•ì¸:
     ```
     ğŸ”µ Google ë¡œê·¸ì¸ ì‹œì‘
     ğŸ”µ Google OAuth URLë¡œ ì´ë™: https://...
     ```

4. ê¶Œí•œ ìŠ¹ì¸ í›„:
   - ë°±ì—”ë“œ ì½˜ì†”ì—ì„œ ì¿ í‚¤ ì„¤ì • ë¡œê·¸ í™•ì¸:
     ```
     ğŸª ì¿ í‚¤ ì„¤ì • ì‹œì‘ (Google)
        - DEBUG ëª¨ë“œ: True
        - Secure ì„¤ì •: False
        - ì‚¬ìš©ì: user@example.com
        âœ… access_token ì¿ í‚¤ ì„¤ì • ì™„ë£Œ
        âœ… refresh_token ì¿ í‚¤ ì„¤ì • ì™„ë£Œ
        âœ… user ì¿ í‚¤ ì„¤ì • ì™„ë£Œ
     ğŸ”„ /startë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
     ```

5. `/start` í˜ì´ì§€ ë¡œë“œ:
   - í”„ë¡ íŠ¸ì—”ë“œ ì½˜ì†”ì—ì„œ ë¡œê·¸ í™•ì¸:
     ```
     ğŸ“„ Start í˜ì´ì§€ ë¡œë“œ
     âœ… ë¡œê·¸ì¸ í™•ì¸ë¨ (ì¿ í‚¤)
     ğŸ‘¤ ì‚¬ìš©ì ì •ë³´: {email: "...", name: "..."}
     ```

6. ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬ > Application > Cookies í™•ì¸:
   - `access_token` (HttpOnly) âœ…
   - `refresh_token` (HttpOnly) âœ…
   - `user` (ì¼ë°˜ ì¿ í‚¤) âœ…

## ì˜ˆìƒ ê²°ê³¼

### ì •ìƒ í”Œë¡œìš°
1. `/login` ì ‘ì†
2. Google ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
3. Google ê³„ì • ì„ íƒ (ì²« ë¡œê·¸ì¸ ì‹œ ê¶Œí•œ ìŠ¹ì¸)
4. `/start`ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
5. ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
6. **ë¬´í•œ ë£¨í”„ ì—†ìŒ** âœ…

### ì¬ë¡œê·¸ì¸ ì‹œ
1. `/login` ì ‘ì†
2. Google ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
3. **ê³„ì • ì„ íƒë§Œ í‘œì‹œ** (ê¶Œí•œ ìŠ¹ì¸ í™”ë©´ ì—†ìŒ)
4. `/start`ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
5. ì •ìƒ ë¡œê·¸ì¸ âœ…

## ì¶”ê°€ ê°œì„  ì‚¬í•­

### Gmail ê¶Œí•œ ì¬ìŠ¹ì¸ì´ í•„ìš”í•œ ê²½ìš°
Gmail ê¶Œí•œì´ ìƒˆë¡œ ì¶”ê°€ë˜ì–´ ì¬ìŠ¹ì¸ì´ í•„ìš”í•œ ê²½ìš°ì—ë§Œ `prompt="consent"`ë¥¼ ì‚¬ìš©:

```python
# íŠ¹ì • ì‚¬ìš©ìì—ê²Œë§Œ ì¬ìŠ¹ì¸ ìš”ì²­
def get_authorization_url(self, force_consent: bool = False) -> str:
    prompt = "consent" if force_consent else "select_account"
    url, _ = client.create_authorization_url(
        self.AUTHORIZE_URL,
        state=state or secrets.token_urlsafe(16),
        access_type="offline",
        prompt=prompt,
        include_granted_scopes="true"
    )
    return url
```

### ì¿ í‚¤ ë§Œë£Œ ì‹œê°„ í™•ì¸
- Access Token: 30ë¶„ (ê¸°ë³¸ê°’)
- Refresh Token: 7ì¼ (ê¸°ë³¸ê°’)
- í•„ìš”ì‹œ `.env` íŒŒì¼ì—ì„œ ì¡°ì • ê°€ëŠ¥:
  ```
  ACCESS_TOKEN_EXPIRE_MINUTES=60
  REFRESH_TOKEN_EXPIRE_DAYS=30
  ```

## ë¬¸ì œ í•´ê²° ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] `prompt="consent"` â†’ `prompt="select_account"` ë³€ê²½
- [x] ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ `logout(false)` ì œê±°
- [x] ì¿ í‚¤ `path="/"` ì„¤ì • ì¶”ê°€
- [x] ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
- [ ] í…ŒìŠ¤íŠ¸ ë° í™•ì¸
- [ ] ì •ìƒ ë™ì‘ í™•ì¸ í›„ ë””ë²„ê¹… ë¡œê·¸ ì œê±° (ì„ íƒì‚¬í•­)

