<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Virtual Desk Assistant - Hiyori</title>

   <!-- ë°°ê²½ ì™„ì „ íˆ¬ëª… + ìºë¦­í„°ë§Œ í´ë¦­ ê°€ëŠ¥ -->
   <style>
     html, body {
       margin: 0;
       height: 100%;
       overflow: hidden;
       background: transparent;
       font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
       pointer-events: none; /* ê¸°ë³¸ì ìœ¼ë¡œ í´ë¦­ ë¶ˆê°€ */
     }
     
     /* ========================================
      * ì±„íŒ… íŒ¨ë„ (ì™¼ìª½ ê³ ì •)
      * ======================================== */
     #chat-panel {
       position: fixed;
       left: 20px;
       top: 5vh;
       width: 350px;
       height: 85vh;
       display: flex;
       flex-direction: column;
       padding: 20px;
       box-sizing: border-box;
       pointer-events: auto !important; /* ğŸ”¥ ì±„íŒ… íŒ¨ë„ì€ ë¬´ì¡°ê±´ í´ë¦­ ê°€ëŠ¥ */
       background: rgba(255, 250, 240, 0.95); /* ğŸ”¥ 95% ë¶ˆíˆ¬ëª… ì•„ì´ë³´ë¦¬ */
       border-radius: 20px;
       box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
       backdrop-filter: blur(10px); /* ë¸”ëŸ¬ íš¨ê³¼ */
       z-index: 9999 !important; /* ğŸ”¥ ìµœìƒìœ„ ë ˆì´ì–´ */
       border: 2px solid rgba(200, 200, 200, 0.5);
       transition: opacity 0.3s ease, transform 0.3s ease;
       isolation: isolate; /* ìƒˆë¡œìš´ stacking context ìƒì„± */
     }
     
     #chat-panel,
     #chat-panel * {
       pointer-events: auto !important; /* ğŸ”¥ ëª¨ë“  í•˜ìœ„ ìš”ì†Œë„ í´ë¦­ ê°€ëŠ¥ */
       cursor: default !important;
     }
     
     #chat-input,
     #send-btn {
       cursor: text !important;
     }
     
     #send-btn {
       cursor: pointer !important;
     }
     
     #chat-panel h2 {
       margin: 0 0 15px 0;
       font-size: 20px;
       font-weight: 700;
       color: #333;
       text-align: center;
     }
     
     /* ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ */
     #messages {
       flex: 1;
       overflow-y: auto;
       padding: 15px;
       background: rgba(245, 245, 240, 0.9); /* ğŸ”¥ 90% ë¶ˆíˆ¬ëª… ì˜…ì€ ì•„ì´ë³´ë¦¬ */
       border-radius: 12px;
       margin-bottom: 15px;
     }
     
     /* ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
     #messages::-webkit-scrollbar {
       width: 8px;
     }
     
     #messages::-webkit-scrollbar-track {
       background: rgba(0, 0, 0, 0.05);
       border-radius: 4px;
     }
     
     #messages::-webkit-scrollbar-thumb {
       background: rgba(0, 0, 0, 0.2);
       border-radius: 4px;
     }
     
     #messages::-webkit-scrollbar-thumb:hover {
       background: rgba(0, 0, 0, 0.3);
     }
     
     /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
     .message {
       margin-bottom: 12px;
       display: flex;
       animation: fadeIn 0.3s ease-in;
     }
     
     @keyframes fadeIn {
       from { opacity: 0; transform: translateY(10px); }
       to { opacity: 1; transform: translateY(0); }
     }
     
     .message.user {
       justify-content: flex-end;
     }
     
     .message.assistant {
       justify-content: flex-start;
     }
     
     .message .bubble {
       max-width: 75%;
       padding: 12px 16px;
       border-radius: 16px;
       word-wrap: break-word;
       font-size: 14px;
       line-height: 1.5;
       background: rgba(255, 250, 240, 0.8); /* ğŸ”¥ 80% ë¶ˆíˆ¬ëª… ì•„ì´ë³´ë¦¬ */
       color: #333;
       box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
     }
     
     .message.user .bubble {
       background: linear-gradient(135deg, rgba(100, 150, 255, 0.85), rgba(120, 170, 255, 0.85)); /* ğŸ”¥ 85% ë¶ˆíˆ¬ëª… */
       color: white;
     }
     
     /* ì…ë ¥ ì˜ì—­ */
     #input-area {
       display: flex;
       gap: 10px;
     }
     
     #chat-input {
       flex: 1;
       padding: 12px 16px;
       border: 2px solid rgba(100, 150, 255, 0.3);
       border-radius: 12px;
       font-size: 14px;
       background: rgba(255, 255, 255, 0.9); /* ğŸ”¥ 90% ë¶ˆíˆ¬ëª… */
       color: #333;
       outline: none;
       transition: all 0.2s;
       box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
     }
     
     #chat-input:focus {
       border-color: rgba(100, 150, 255, 0.6);
       box-shadow: 0 4px 12px rgba(100, 150, 255, 0.2);
     }
     
     #send-btn {
       padding: 12px 24px;
       border: none;
       border-radius: 12px;
       background: linear-gradient(135deg, rgba(100, 150, 255, 0.9), rgba(80, 130, 235, 0.9)); /* ğŸ”¥ 90% ë¶ˆíˆ¬ëª… */
       color: white;
       font-size: 14px;
       font-weight: 600;
       cursor: pointer;
       transition: all 0.2s;
       box-shadow: 0 4px 12px rgba(100, 150, 255, 0.3);
     }
     
     #send-btn:hover:not(:disabled) {
       transform: translateY(-2px);
       box-shadow: 0 6px 16px rgba(100, 150, 255, 0.4);
     }
     
     #send-btn:active:not(:disabled) {
       transform: translateY(0);
     }
     
     #send-btn:disabled {
       background: rgba(150, 150, 150, 0.6);
       cursor: not-allowed;
       transform: none;
     }
     
     /* ========================================
      * Live2D ìŠ¤í…Œì´ì§€ (ì „ì²´ í™”ë©´)
      * ======================================== */
     #stage {
       position: fixed;
       inset: 0;
       pointer-events: none; /* ğŸ”¥ ë°°ê²½ì€ í´ë¦­ ë¶ˆê°€ */
       z-index: 1; /* ì±„íŒ…ì°½ ì•„ë˜ */
     }
     
     /* canvasë§Œ í´ë¦­ ê°€ëŠ¥ (Live2D ìºë¦­í„°) */
     #stage canvas {
       pointer-events: auto !important;
       cursor: move;
       z-index: 10;
     }
   </style>
</head>

<body>
  <!-- Live2D ìŠ¤í…Œì´ì§€ (ë°°ê²½, ì „ì²´ í™”ë©´) -->
  <div id="stage"></div>
  
  <!-- ì±„íŒ… íŒ¨ë„ (ê³ ì • ìœ„ì¹˜, ìµœìƒìœ„) -->
  <div id="chat-panel">
    <h2>ğŸ’¬ AI ë¹„ì„œ</h2>
    <div id="messages"></div>
    <div id="input-area">
      <input 
        type="text" 
        id="chat-input" 
        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
        autocomplete="off"
      />
      <button id="send-btn">ì „ì†¡</button>
    </div>
  </div>

  <script>
    /****************************************************************
     * Electron ipcRenderer ì¤€ë¹„
     * - ë¸Œë¼ìš°ì €ë¡œ ì—´ì—ˆì„ ë•ŒëŠ” requireê°€ ì—†ìœ¼ë‹ˆ try/catch
     ****************************************************************/
    let ipcRenderer = null;
    try {
      // electron í™˜ê²½
      ipcRenderer = require('electron').ipcRenderer;
    } catch (e) {
      console.warn('Electron í™˜ê²½ì´ ì•„ë‹ˆì–´ì„œ ipcRenderer ì—†ìŒ:', e);
    }

    /****************************************************************
     * Activity Monitor (ì¸ë¼ì¸)
     ****************************************************************/
    let activityMonitorCleanup = null;
    
    // Activity Monitor ì„¤ì •
    const ACTIVITY_CONFIG = {
      dev: {
        idleThresholdMs: 3 * 1000,        // 3ì´ˆ
        longActiveThresholdMs: 10 * 1000, // 10ì´ˆ
        checkIntervalMs: 1000,
      },
      prod: {
        idleThresholdMs: 5 * 60 * 1000,      // 5ë¶„
        longActiveThresholdMs: 50 * 60 * 1000, // 50ë¶„
        checkIntervalMs: 2000,
      }
    };
    
    function setupActivityMonitor(options) {
      const { mode, onIdle, onLongActive } = options;
      const config = ACTIVITY_CONFIG[mode];
      
      console.log(`ğŸ” Activity Monitor ì‹œì‘ (${mode} ëª¨ë“œ)`);
      console.log(`   - Idle ê¸°ì¤€: ${config.idleThresholdMs / 1000}ì´ˆ`);
      console.log(`   - ì¥ì‹œê°„ í™œë™ ê¸°ì¤€: ${config.longActiveThresholdMs / 1000}ì´ˆ`);
      
      let lastInputAt = Date.now();
      let sessionStartAt = Date.now();
      let isIdle = false;
      let hasNotifiedLongActive = false;
      let checkTimer = null;
      
      function handleUserInput() {
        const now = Date.now();
        lastInputAt = now;
        
        if (isIdle) {
          console.log('âœ… í™œë™ ì¬ê°œ - ìƒˆ ì„¸ì…˜ ì‹œì‘');
          isIdle = false;
          sessionStartAt = now;
          hasNotifiedLongActive = false;
        }
      }
      
      function checkActivity() {
        const now = Date.now();
        const timeSinceLastInput = now - lastInputAt;
        const currentSessionDuration = now - sessionStartAt;
        
        // Idle ì²´í¬
        if (!isIdle && timeSinceLastInput >= config.idleThresholdMs) {
          isIdle = true;
          console.log(`ğŸ˜´ Idle ìƒíƒœ ì§„ì… (${timeSinceLastInput / 1000}ì´ˆ ë™ì•ˆ ì…ë ¥ ì—†ìŒ)`);
          
          try {
            onIdle();
          } catch (error) {
            console.error('âŒ onIdle ì½œë°± ì˜¤ë¥˜:', error);
          }
          
          sessionStartAt = now;
          hasNotifiedLongActive = false;
          return;
        }
        
        // ì¥ì‹œê°„ í™œë™ ì²´í¬
        if (!isIdle && !hasNotifiedLongActive) {
          if (currentSessionDuration >= config.longActiveThresholdMs) {
            hasNotifiedLongActive = true;
            console.log(`â° ì¥ì‹œê°„ í™œë™ ê°ì§€ (${currentSessionDuration / 1000}ì´ˆ)`);
            
            try {
              onLongActive();
            } catch (error) {
              console.error('âŒ onLongActive ì½œë°± ì˜¤ë¥˜:', error);
            }
          }
        }
        
        // ë””ë²„ê¹… ë¡œê·¸
        if (mode === 'dev' && !isIdle && !hasNotifiedLongActive) {
          const remaining = (config.longActiveThresholdMs - currentSessionDuration) / 1000;
          if (remaining > 0 && Math.floor(remaining) % 2 === 0) {
            console.log(`â±ï¸  ì¥ì‹œê°„ í™œë™ê¹Œì§€ ${remaining.toFixed(0)}ì´ˆ ë‚¨ìŒ`);
          }
        }
      }
      
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
      const events = ['mousemove', 'mousedown', 'wheel', 'keydown'];
      events.forEach(eventType => {
        window.addEventListener(eventType, handleUserInput, { passive: true });
      });
      
      console.log('ğŸ‘‚ ì…ë ¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡:', events.join(', '));
      
      // íƒ€ì´ë¨¸ ì‹œì‘
      checkTimer = setInterval(checkActivity, config.checkIntervalMs);
      console.log(`â²ï¸  ${config.checkIntervalMs}ms ê°„ê²©ìœ¼ë¡œ ì²´í¬ ì‹œì‘`);
      
      // Cleanup í•¨ìˆ˜ ë°˜í™˜
      return function cleanup() {
        console.log('ğŸ§¹ Activity Monitor ì •ë¦¬');
        events.forEach(eventType => {
          window.removeEventListener(eventType, handleUserInput);
        });
        if (checkTimer) {
          clearInterval(checkTimer);
        }
      };
    }
    
    function setupActivityMonitorWithMotions() {
      const mode = 'dev'; // ê°œë°œ ëª¨ë“œ
      
      activityMonitorCleanup = setupActivityMonitor({
        mode: mode,
        
        onIdle: () => {
          console.log('ğŸ­ [Idle ì½œë°± ì‹¤í–‰]');
          
          // ìºë¦­í„° ëª¨ì…˜
          if (model) {
            model.motion('Idle');
            console.log('   ìºë¦­í„°: Idle ëª¨ì…˜ ì¬ìƒ');
          }
          
          // ì±„íŒ…ì°½ì— ë©”ì‹œì§€
          addMessage('assistant', 'ì¡°ê¸ˆ ì‰¬ê³  ê³„ì‹ ê°€ìš”? ğŸ˜Š');
        },
        
        onLongActive: () => {
          console.log('ğŸ­ [ì¥ì‹œê°„ í™œë™ ì½œë°± ì‹¤í–‰]');
          
          // ìºë¦­í„° ëª¨ì…˜
          if (model) {
            model.motion('Tap@Body');
            console.log('   ìºë¦­í„°: Tap@Body ëª¨ì…˜ ì¬ìƒ');
          }
          
          // ì±„íŒ…ì°½ì— ë©”ì‹œì§€
          addMessage('assistant', 'ì˜¤ë˜ ì¼í•˜ì…¨ë„¤ìš”! ì ê¹ ì¼ì–´ë‚˜ì„œ ìŠ¤íŠ¸ë ˆì¹­ ì–´ë•Œìš”? ğŸ¤¸â€â™€ï¸');
        }
      });
    }
    
    /****************************************************************
     * ì±„íŒ… ì„œë¹„ìŠ¤ (ì¸ë¼ì¸)
     ****************************************************************/
    async function callChatModule(userText) {
      console.log('ğŸ“¨ ì‚¬ìš©ì ë©”ì‹œì§€:', userText);
      
      // 1-2ì´ˆ ë”œë ˆì´ ì‹œë®¬ë ˆì´ì…˜
      await new Promise(resolve => setTimeout(resolve, 1000 + Math.random() * 1000));
      
      // ë”ë¯¸ ì‘ë‹µ ëª©ë¡
      const dummyResponses = [
        'ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ˜Š',
        'ë„¤, ì•Œê² ìŠµë‹ˆë‹¤. ì œê°€ ë„ì™€ë“œë¦¬ê² ìŠµë‹ˆë‹¤!',
        'í¥ë¯¸ë¡œìš´ ì§ˆë¬¸ì´ë„¤ìš”! ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.',
        'ì¢‹ì€ ìƒê°ì´ì—ìš”! ê·¸ë ‡ê²Œ í•´ë³´ì‹œëŠ” ê±´ ì–´ë–¨ê¹Œìš”?',
        'ë” ìì„¸íˆ ì„¤ëª…í•´ì£¼ì‹œë©´ ë” ì •í™•í•˜ê²Œ ë‹µë³€ë“œë¦´ ìˆ˜ ìˆì„ ê²ƒ ê°™ì•„ìš”.',
      ];
      
      const response = dummyResponses[Math.floor(Math.random() * dummyResponses.length)];
      console.log('ğŸ¤– AI ì‘ë‹µ:', response);
      return response;
    }

    /****************************************************************
     * ì±„íŒ… íŒ¨ë„ UI ë° ìƒíƒœ ê´€ë¦¬ (ì¸ë¼ì¸)
     ****************************************************************/
    let messages = [];
    let isPanelVisible = true;
    let chatPanel = null;
    let messagesContainer = null;
    let chatInput = null;
    let sendBtn = null;
    let isChatPanelInitialized = false; // ğŸ”¥ ì¤‘ë³µ ì´ˆê¸°í™” ë°©ì§€

    function initChatPanel() {
      // ğŸ”¥ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆìœ¼ë©´ ë¬´ì‹œ
      if (isChatPanelInitialized) {
        console.log('âš ï¸  ì±„íŒ… íŒ¨ë„ ì´ë¯¸ ì´ˆê¸°í™”ë¨ - ìŠ¤í‚µ');
        return;
      }
      
      console.log('ğŸ’¬ ì±„íŒ… íŒ¨ë„ ì´ˆê¸°í™” ì¤‘...');
      
      chatPanel = document.getElementById('chat-panel');
      messagesContainer = document.getElementById('messages');
      chatInput = document.getElementById('chat-input');
      sendBtn = document.getElementById('send-btn');
      
      if (!chatPanel || !messagesContainer || !chatInput || !sendBtn) {
        console.error('âŒ ì±„íŒ… íŒ¨ë„ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }
      
      // ì´ˆê¸° ë©”ì‹œì§€ ì¶”ê°€
      addMessage('assistant', 'ì•ˆë…•í•˜ì„¸ìš”! ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”? ğŸ˜Š');
      
      // ğŸ”¥ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ (once ì˜µì…˜ìœ¼ë¡œ ì¤‘ë³µ ë°©ì§€)
      sendBtn.addEventListener('click', handleSendMessage);
      
      chatInput.addEventListener('keydown', handleChatInputKeydown);
      
      // Cmd/Ctrl + Enterë¡œ íŒ¨ë„ í† ê¸€
      window.addEventListener('keydown', handleGlobalKeydown);
      
      isChatPanelInitialized = true; // ğŸ”¥ ì´ˆê¸°í™” ì™„ë£Œ í”Œë˜ê·¸
      console.log('âœ… ì±„íŒ… íŒ¨ë„ ì´ˆê¸°í™” ì™„ë£Œ');
    }

    // ğŸ”¥ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ë¥¼ ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬ (ì¤‘ë³µ ë“±ë¡ ë°©ì§€)
    function handleChatInputKeydown(e) {
      // í•œê¸€ ì…ë ¥ ì¤‘(composing)ì´ë©´ ë¬´ì‹œ
      if (e.isComposing || e.keyCode === 229) {
        return;
      }
      
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        handleSendMessage();
      }
    }

    function handleGlobalKeydown(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
        e.preventDefault();
        togglePanel();
      }
    }

    async function handleSendMessage() {
      const text = chatInput.value.trim();
      if (!text) return;
      
      // ğŸ”¥ ì „ì†¡ ì¤‘ì´ë©´ ë¬´ì‹œ (ì¤‘ë³µ ì „ì†¡ ë°©ì§€)
      if (sendBtn.disabled) {
        console.log('âš ï¸  ì´ë¯¸ ì „ì†¡ ì¤‘...');
        return;
      }
      
      addMessage('user', text);
      
      // ğŸ”¥ ì…ë ¥ì°½ ì´ˆê¸°í™” (IME ë¬¸ì œ í•´ê²°)
      chatInput.value = '';
      chatInput.blur(); // í¬ì»¤ìŠ¤ ì œê±°
      setTimeout(() => {
        chatInput.focus(); // ë‹¤ì‹œ í¬ì»¤ìŠ¤
      }, 0);
      
      sendBtn.disabled = true;
      sendBtn.textContent = '...';
      
      try {
        const response = await callChatModule(text);
        addMessage('assistant', response);
      } catch (error) {
        console.error('âŒ ì±„íŒ… ì˜¤ë¥˜:', error);
        addMessage('assistant', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ğŸ˜¢');
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = 'ì „ì†¡';
      }
    }

    function addMessage(role, text) {
      messages.push({ role, text });
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${role}`;
      
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      
      messageDiv.appendChild(bubble);
      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      console.log(`ğŸ’¬ [${role}]: ${text}`);
    }

    function togglePanel() {
      isPanelVisible = !isPanelVisible;
      
      if (isPanelVisible) {
        chatPanel.style.display = 'flex';
        console.log('ğŸ‘ï¸ ì±„íŒ… íŒ¨ë„ í‘œì‹œ');
      } else {
        chatPanel.style.display = 'none';
        console.log('ğŸ™ˆ ì±„íŒ… íŒ¨ë„ ìˆ¨ê¹€');
      }
    }

    /****************************************************************
     * ìˆœì°¨ ë¡œë”
     * - ì˜ì¡´ì„± â†’ ì½”ì–´ â†’ í”ŒëŸ¬ê·¸ì¸ ìˆœì„œ ë³´ì¥
     * - CDN ì‹¤íŒ¨ ì‹œ ë‹¤ìŒ í›„ë³´ ìë™ ì‹œë„
     ****************************************************************/
    function loadScript(url) {
      return new Promise((resolve, reject) => {
        const s = document.createElement('script');
        s.src = url;
        s.async = false;               // ë¡œë“œ ìˆœì„œ ë³´ì¥(ì¤‘ìš”)
        s.onload = () => { console.log('âœ… ë¡œë“œ ì„±ê³µ:', url); resolve(); };
        s.onerror = () => { console.error('âŒ ë¡œë“œ ì‹¤íŒ¨:', url); reject(new Error(url)); };
        document.head.appendChild(s);
      });
    }

    // ì „ì—­ì—ì„œ ì“¸ ì°¸ì¡°ìš© (ìŠ¤ì¼€ì¼ ì¡°ì ˆì„ ìœ„í•´)
    let app = null;
    let model = null;

    async function init() {
      try {
        /******** 1) Pixi.js (v6.x) : í”ŒëŸ¬ê·¸ì¸ 0.4.xì™€ í˜¸í™˜ ********/
        const pixiCdn = [
          'https://cdn.jsdelivr.net/npm/pixi.js@6.5.10/dist/browser/pixi.min.js',
          'https://unpkg.com/pixi.js@6.5.10/dist/browser/pixi.min.js'
        ];
        let ok = false;
        for (const url of pixiCdn) {
          try { await loadScript(url); ok = true; break; } catch {}
        }
        if (!ok) throw new Error('Pixi.js ë¡œë“œ ì‹¤íŒ¨');
        console.log('PIXI.VERSION =', window.PIXI && PIXI.VERSION);

        /******** 2) Live2D Cubism Core : í”ŒëŸ¬ê·¸ì¸ì´ ì°¸ì¡°í•˜ëŠ” ëŸ°íƒ€ì„ ********/
        const coreCdn = [
          'https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js',
          'https://cubism.live2d.com/sdk-web/bin/live2dcubismcore.min.js'
        ];
        ok = false;
        for (const url of coreCdn) {
          try { await loadScript(url); ok = true; break; } catch {}
        }
        if (!ok) throw new Error('Live2D Cubism Core ë¡œë“œ ì‹¤íŒ¨');
        console.log('Live2DCubismCore =', typeof window.Live2DCubismCore); // "object" ê¸°ëŒ€

        /******** 3) pixi-live2d-display (Cubism4 ë¹Œë“œ, 0.4.x) ********/
        const pluginCdn = [
          'https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.js',
          'https://unpkg.com/pixi-live2d-display@0.4.0/dist/cubism4.js',
          'https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display@v0.4.0/dist/cubism4.js'
        ];
        ok = false;
        for (const url of pluginCdn) {
          try {
            await loadScript(url);
            if (window.PIXI?.live2d?.Live2DModel) { ok = true; break; }
          } catch {}
        }
        if (!ok) throw new Error('pixi-live2d-display (cubism4) ë¡œë“œ ì‹¤íŒ¨');

        console.log('PIXI.live2d keys:', Object.keys(PIXI.live2d || {}));

        /******** 4) Pixi ì•± & Live2D ëª¨ë¸ ë¡œë“œ ********/
        // ğŸ”¥ ì „ì²´ ìœˆë„ìš° í¬ê¸°ë¡œ ì•± ìƒì„±
        app = new PIXI.Application({ 
          backgroundAlpha: 0,
          width: window.innerWidth,
          height: window.innerHeight,
          resizeTo: window // ğŸ”¥ windowì— ë§ì¶° ë¦¬ì‚¬ì´ì¦ˆ
        });
        
        // stageì— canvas ì¶”ê°€
        const stageContainer = document.getElementById('stage');
        stageContainer.appendChild(app.view);

        const MODEL_URL = 'public/models/hiyori_free_ko/runtime/hiyori_free_t08.model3.json';
        console.log('ğŸ“¦ ëª¨ë¸ ë¡œë”©:', MODEL_URL);

        model = await PIXI.live2d.Live2DModel.from(MODEL_URL);

         // ë°°ì¹˜: í™”ë©´ ì¤‘ì•™ í•˜ë‹¨ (ë“€ì–¼ ëª¨ë‹ˆí„° ëŒ€ì‘)
         model.anchor.set(0.5, 1);
         model.scale.set(0.18); // ì´ˆê¸° í¬ê¸° (ë¨¸ë¦¬ ì•ˆ ì˜ë¦¬ë„ë¡ ì¶•ì†Œ)
         
         // ìœ„ì¹˜ ì„¤ì • (í™”ë©´ ì¤‘ì•™ ê¸°ì¤€, ìº”ë²„ìŠ¤ í¬ê¸° ê¸°ì¤€)
         const updateModelPosition = () => {
           // ìº”ë²„ìŠ¤ì˜ ë„ˆë¹„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¤‘ì•™ ì¡°ê¸ˆ ì˜¤ë¥¸ìª½
           const canvasWidth = app.screen.width;
           const canvasHeight = app.screen.height;
           model.position.set(canvasWidth * 0.75, canvasHeight - 50);
           console.log(`ğŸ“ ìºë¦­í„° ìœ„ì¹˜: (${model.position.x}, ${model.position.y})`);
         };
         updateModelPosition();
         
         // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
         window.addEventListener('resize', () => {
           updateModelPosition();
         });
         
         app.stage.addChild(model);
         console.log('âœ… ìºë¦­í„°ê°€ í™”ë©´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');

         // ìƒí˜¸ì‘ìš©: íƒ­ ëª¨ì…˜ (ë“œë˜ê·¸ê°€ ì•„ë‹ ë•Œë§Œ)
         model.interactive = true;
         let clickStartPos = null;
         model.on('pointerdown', (e) => {
           clickStartPos = { x: e.data.global.x, y: e.data.global.y };
         });
         model.on('pointerup', (e) => {
           if (!clickStartPos) return;
           const dx = Math.abs(e.data.global.x - clickStartPos.x);
           const dy = Math.abs(e.data.global.y - clickStartPos.y);
           // ì´ë™ ê±°ë¦¬ê°€ 5px ì´í•˜ë©´ í´ë¦­ìœ¼ë¡œ ê°„ì£¼
           if (dx < 5 && dy < 5) {
             console.log('ğŸ‘† ìºë¦­í„° í´ë¦­!');
             model.motion?.('Tap');
           }
           clickStartPos = null;
         });

        console.log('ğŸ‰ ì¤€ë¹„ ì™„ë£Œ!');

        // ëª¨ë¸ ì¤€ë¹„ëœ í›„ ì¸í„°ë™ì…˜ ì œì–´ ë¡œì§ ì„¸íŒ…
        setupInteractionControls();
        
        // ì±„íŒ… íŒ¨ë„ ì´ˆê¸°í™”
        initChatPanel();
        
        // ğŸ”¥ Activity Monitor ì´ˆê¸°í™” (ìºë¦­í„° ëª¨ì…˜ ì—°ë™)
        setupActivityMonitorWithMotions();

      } catch (err) {
        console.error('âŒ ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
        document.getElementById('app').innerHTML =
          `<div style="color:white;padding:20px;font-family:monospace;">
            <h2>âŒ ë¡œë“œ ì‹¤íŒ¨</h2>
            <p>${err.message}</p>
            <p>DevTools â†’ Network/Console í™•ì¸</p>
          </div>`;
      }
    }

    /****************************************************************
     * ì¸í„°ë™ì…˜ ì œì–´
     * - ìºë¦­í„° ë“œë˜ê·¸: ìºë¦­í„° ìœ„ì¹˜ ì´ë™
     * - +/- í‚¤: í¬ê¸° ì¡°ì ˆ
     * - ìºë¦­í„° ë°”ìš´ë”© ë°•ìŠ¤ë§Œ í´ë¦­ ê°€ëŠ¥ (ë™ì  ì¡°ì ˆ)
     * - ì±„íŒ… íŒ¨ë„ì€ ë³„ë„ ì²˜ë¦¬
     ****************************************************************/
    function setupInteractionControls() {
      let isDragging = false;
      let lastClientX = 0;
      let lastClientY = 0;

      // í¬ê¸° ì¡°ì ˆ í•¨ìˆ˜
      const adjustScale = (delta) => {
        if (!model) return;
        const step = 0.05;
        let newScale = model.scale.x + delta * step;
        newScale = Math.max(0.1, Math.min(1.0, newScale));
        model.scale.set(newScale);
        console.log('ğŸ” í¬ê¸°:', newScale.toFixed(2));
      };

      // í‚¤ë³´ë“œë¡œ í¬ê¸° ì¡°ì ˆ ë° ì¢…ë£Œ: +/- í‚¤, ESC í‚¤
      // ì£¼ì˜: Cmd/Ctrl + EnterëŠ” ì±„íŒ… íŒ¨ë„ì—ì„œ ì²˜ë¦¬
      window.addEventListener('keydown', (e) => {
        // ì±„íŒ… ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•ŒëŠ” í¬ê¸° ì¡°ì ˆ ë¹„í™œì„±í™”
        const chatInput = document.getElementById('chat-input');
        if (document.activeElement === chatInput) {
          return; // ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤ê°€ ìˆìœ¼ë©´ ë¬´ì‹œ
        }
        
        if (e.key === '+' || e.key === '=') {
          e.preventDefault();
          adjustScale(1);
        } else if (e.key === '-' || e.key === '_') {
          e.preventDefault();
          adjustScale(-1);
        } else if (e.key === 'Escape') {
          e.preventDefault();
          console.log('âŒ¨ï¸  ESC í‚¤ - ì•± ì¢…ë£Œ');
          if (ipcRenderer) {
            ipcRenderer.send('va:request-quit');
          }
        }
      });

      // ìºë¦­í„° ë“œë˜ê·¸ë¡œ ìœ„ì¹˜ ì´ë™
      document.addEventListener('mousedown', (e) => {
        // ìº”ë²„ìŠ¤ê°€ ì•„ë‹ˆê±°ë‚˜ ì±„íŒ… íŒ¨ë„ ì˜ì—­ì´ë©´ ë¬´ì‹œ
        if (e.target.tagName !== 'CANVAS') return;
        
        isDragging = true;
        lastClientX = e.clientX;
        lastClientY = e.clientY;
        e.preventDefault();
      });

      document.addEventListener('mousemove', (e) => {
        if (isDragging && model) {
          const dx = e.clientX - lastClientX;
          const dy = e.clientY - lastClientY;
          lastClientX = e.clientX;
          lastClientY = e.clientY;
          
          // ìºë¦­í„° ìœ„ì¹˜ ì´ë™
          model.position.x += dx;
          model.position.y += dy;
        }
      });

      document.addEventListener('mouseup', () => {
        isDragging = false;
      });

      // ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì²˜ë¦¬: ì±„íŒ… íŒ¨ë„ vs ìºë¦­í„°
      if (ipcRenderer && model) {
        let isOverCharacter = false;
        let isOverChatPanel = false;
        
        const checkIfOverCharacter = (clientX, clientY) => {
          if (!model) return false;
          
          // ìºë¦­í„°ì˜ ì‹¤ì œ ë°”ìš´ë”© ë°•ìŠ¤ ê°€ì ¸ì˜¤ê¸°
          const bounds = model.getBounds();
          
          // Live2D ë°”ìš´ë”© ë°•ìŠ¤ê°€ ì‹¤ì œë³´ë‹¤ ë„“ìœ¼ë¯€ë¡œ ì¢Œìš°ë¥¼ ëŒ€í­ ì¶•ì†Œ
          const actualWidth = bounds.width * 0.4;
          const widthOffset = (bounds.width - actualWidth) / 2;
          const verticalMargin = bounds.height * 0.05;
          
          return clientX >= bounds.x + widthOffset && 
                 clientX <= bounds.x + widthOffset + actualWidth &&
                 clientY >= bounds.y - verticalMargin && 
                 clientY <= bounds.y + bounds.height + verticalMargin;
        };
        
        const checkIfOverChatPanel = (clientX, clientY) => {
          const chatPanel = document.getElementById('chat-panel');
          if (!chatPanel || chatPanel.style.display === 'none') return false;
          
          const rect = chatPanel.getBoundingClientRect();
          return clientX >= rect.left && 
                 clientX <= rect.right && 
                 clientY >= rect.top && 
                 clientY <= rect.bottom;
        };
        
        document.addEventListener('mousemove', (e) => {
          const wasOverChat = isOverChatPanel;
          const wasOverChar = isOverCharacter;
          
          // ì±„íŒ… íŒ¨ë„ ì²´í¬ (ìš°ì„ ìˆœìœ„ ë†’ìŒ)
          isOverChatPanel = checkIfOverChatPanel(e.clientX, e.clientY);
          
          // ìºë¦­í„° ì²´í¬ (ì±„íŒ… íŒ¨ë„ì´ ì•„ë‹ ë•Œë§Œ)
          if (!isOverChatPanel) {
            isOverCharacter = checkIfOverCharacter(e.clientX, e.clientY);
          } else {
            isOverCharacter = false;
          }
          
          // ìƒíƒœ ë³€ê²½ ì‹œì—ë§Œ IPC ì „ì†¡
          if (wasOverChat !== isOverChatPanel || wasOverChar !== isOverCharacter) {
            // ì±„íŒ… íŒ¨ë„ì´ë‚˜ ìºë¦­í„° ìœ„ì— ìˆìœ¼ë©´ í´ë¦­ ê°€ëŠ¥
            const shouldAcceptClicks = isOverChatPanel || isOverCharacter;
            ipcRenderer.send('va:set-ignore-mouse', !shouldAcceptClicks);
            
            if (isOverChatPanel) {
              console.log('ğŸ’¬ ì±„íŒ… íŒ¨ë„ ìœ„');
            } else if (isOverCharacter) {
              console.log('ğŸ­ ìºë¦­í„° ìœ„');
            }
          }
        });
      }
    }

    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
