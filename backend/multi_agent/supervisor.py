"""
Supervisor Agent

ì¤‘ì•™ Supervisor Agent
ì‚¬ìš©ì ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ ì „ë¬¸ ì—ì´ì „íŠ¸ë¥¼ ì„ íƒí•˜ê³  ì¡°ìœ¨í•©ë‹ˆë‹¤.
"""

import time
import os
from datetime import datetime
from typing import Dict, Any, Optional, List
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.messages import HumanMessage, AIMessage, SystemMessage
from langgraph.prebuilt import create_react_agent

from .config import multi_agent_config
from .tools.agent_tools import get_all_agent_tools
from .schemas import MultiAgentRequest, MultiAgentResponse
from .context import session_context, user_context, reset_context

# SuperViser Agent í´ë˜ìŠ¤
# Tool Calling íŒ¨í„´ìœ¼ë¡œ ì—ì´ì „íŠ¸ í˜¸ì¶œ
class SupervisorAgent:
    
    # ì´ˆê¸°í™” í•¨ìˆ˜
    def __init__(self):

        # LangSmith ì¶”ì  ì„¤ì •
        if multi_agent_config.LANGSMITH_TRACING:
            os.environ["LANGCHAIN_TRACING_V2"] = "true"
            os.environ["LANGCHAIN_API_KEY"] = multi_agent_config.LANGSMITH_API_KEY or ""
            os.environ["LANGCHAIN_PROJECT"] = multi_agent_config.LANGSMITH_PROJECT
        
        # LLM ì´ˆê¸°í™”
        self.llm = ChatOpenAI(
            model=multi_agent_config.SUPERVISOR_MODEL,
            temperature=multi_agent_config.SUPERVISOR_TEMPERATURE,
            max_tokens=multi_agent_config.MAX_TOKENS,
            api_key=multi_agent_config.OPENAI_API_KEY
        )
        
        # ì „ë¬¸ ì—ì´ì „íŠ¸ ë„êµ¬ ê°€ì ¸ì˜¤ê¸°
        self.tools = get_all_agent_tools()
        
        # System message ìƒì„±
        self.system_message = self._create_system_message()
        
        # LangGraph Agent ìƒì„± (LangChain 1.1.0 + LangGraph 1.0.4 í˜¸í™˜)
        # LangGraph 1.0.4ì—ì„œëŠ” prompt íŒŒë¼ë¯¸í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ system message ì „ë‹¬
        self.agent_executor = create_react_agent(
            model=self.llm,
            tools=self.tools,
            prompt=self.system_message
        )
    
    # System message ìƒì„± í•¨ìˆ˜(45ì¤„ì— rtn)
    # ì—­í• , ì—ì´ì „íŠ¸ ëª©ë¡, í‚¤ì›Œë“œ, ì˜ˆì‹œ, ê·œì¹™ ë“±ë“± ì œê³µ
    def _create_system_message(self) -> str:

        system_message = """ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë¶„ì„í•˜ì—¬ ì ì ˆí•œ ì „ë¬¸ ì—ì´ì „íŠ¸ì—ê²Œ ì‘ì—…ì„ ìœ„ì„í•˜ëŠ” Supervisor AIì…ë‹ˆë‹¤.

**ë‹¹ì‹ ì˜ ì—­í• :**
1. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ì´í•´í•˜ê³  ì˜ë„ë¥¼ íŒŒì•…í•©ë‹ˆë‹¤.
2. ì§ˆë¬¸ì— í¬í•¨ëœ í‚¤ì›Œë“œì™€ ë§¥ë½ì„ ë¶„ì„í•©ë‹ˆë‹¤.
3. ì§ˆë¬¸ì— ê°€ì¥ ì í•©í•œ ì „ë¬¸ ì—ì´ì „íŠ¸ë¥¼ ì„ íƒí•©ë‹ˆë‹¤.
4. ì„ íƒí•œ ì—ì´ì „íŠ¸ì—ê²Œ ì‘ì—…ì„ ìœ„ì„í•˜ê³  ê²°ê³¼ë¥¼ ë°›ìŠµë‹ˆë‹¤.
5. ìµœì¢… ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ëª…í™•í•˜ê³  ì¹œì ˆí•˜ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤.

**ì‚¬ìš© ê°€ëŠ¥í•œ ì „ë¬¸ ì—ì´ì „íŠ¸:**

1. **chatbot_tool**: ì¼ë°˜ ëŒ€í™”, ì¸ì‚¬, ì¡ë‹´
   - í‚¤ì›Œë“œ: ì•ˆë…•, í•˜ì´, í—¬ë¡œ, ë°˜ê°€ì›Œ, ê³ ë§ˆì›Œ, ê°ì‚¬, ë‚ ì”¨, ì˜¤ëŠ˜, ë‚´ì¼, ì–´ì œ, ì‹œê°„, ëª‡ ì‹œ, ê¸°ë¶„, ì¢‹ì•„, ì‹«ì–´, í–‰ë³µ, ì˜ ì§€ë‚´, ì–´ë–»ê²Œ ì§€ë‚´, ë­í•´, ë­í•˜ë‹ˆ, ë†€ì, ì¬ë¯¸, ì¦ê±°ì›Œ, ì¢‹ì€ í•˜ë£¨, ì¢‹ì€ ë°¤, ì˜ ì, ì•ˆë…•íˆ, ë­ì•¼, ê·¸ê²Œ ë­ì•¼, ì¬ë°Œì–´, ì›ƒê²¨, í•˜í•˜, í—¤í—¤
   - ì˜ˆì‹œ: "ì•ˆë…•í•˜ì„¸ìš”!", "ì˜¤ëŠ˜ ë‚ ì”¨ ì¢‹ë„¤ìš”", "ê³ ë§ˆì›Œìš”"

2. **rag_tool**: íšŒì‚¬ ë¬¸ì„œ, ê·œì •, ì •ì±… ê²€ìƒ‰
   - ì‚¬ìš© ì¡°ê±´:
     * ì‚¬ìš©ìê°€ íšŒì‚¬ ë‚´ë¶€ ê·œì •, ì •ì±…, ì ˆì°¨ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ì‚¬ì‹¤ ê´€ê³„ë¥¼ ì›í•  ë•Œ
     * ì¼ë°˜ì ì¸ ì§€ì‹ì´ ì•„ë‹Œ, 'ìš°ë¦¬ íšŒì‚¬'ì˜ íŠ¹ì •í•œ ì •ë³´ë¥¼ ë¬¸ì„œ ê¸°ë°˜ìœ¼ë¡œ í™•ì¸í•´ì•¼ í•  ë•Œ
     * "ì—°ì°¨ ê·œì •ì´ ë­ì•¼?" ì²˜ëŸ¼ ì •í•´ì§„ ê·œì¹™ì´ë‚˜ ë§¤ë‰´ì–¼ì— ëŒ€í•œ ë‹µë³€ì´ í•„ìš”í•œ ê²½ìš°
   - íŠ¸ë¦¬ê±° ìƒí™©:
     * ëª…ì‹œì  ê²€ìƒ‰ ìš”ì²­: "ê·œì • ì°¾ì•„ì¤˜", "ì •ì±… ì•Œë ¤ì¤˜", "ë§¤ë‰´ì–¼ ê²€ìƒ‰í•´ì¤˜", "ìë£Œ ë³´ì—¬ì¤˜"
     * ê·œì •/ì œë„ ë¬¸ì˜: "ì—°ì°¨ëŠ” ë©°ì¹ ì´ì•¼?", "ì•¼ê·¼ ì‹ëŒ€ ê¸°ì¤€ì´ ë­ì•¼?", "ë³µì§€ í¬ì¸íŠ¸ ì‚¬ìš©ì²˜ ì•Œë ¤ì¤˜"
     * ì ˆì°¨ í™•ì¸: "íœ´ê°€ ì‹ ì²­ ë°©ë²• ì•Œë ¤ì¤˜", "ë²•ì¸ì¹´ë“œ ì‚¬ìš© ì ˆì°¨", "ì§€ì¶œê²°ì˜ì„œ ì‘ì„±ë²•"
   - ì˜ˆì‹œ (ë„êµ¬ ì‚¬ìš© O):
     * "ì—°ì°¨ ìˆ˜ë‹¹ ì§€ê¸‰ ê¸°ì¤€ ì•Œë ¤ì¤˜"
     * "ì˜ë¬´êµìœ¡ì€ ì–´ë””ì„œ ë“¤ì–´ì•¼í•´?"
     * "ìŠ¹ì§„í•˜ë ¤ë©´ ì–´ë–¤ ë…¸ë ¥ì„ í•´ì•¼í•´?"
     * "ì œíœ´ì‚¬ ëª©ë¡ ì•Œë ¤ì¤˜"
   - ì˜ˆì‹œ (ë„êµ¬ ì‚¬ìš© X - chatbot_tool ì‚¬ìš©):
     * "ì—°ì°¨ê°€ ì˜ì–´ë¡œ ë­ì•¼?" â†’ ì¼ë°˜ ìƒì‹/ì–´í•™ (chatbot_tool)
     * "íšŒì‚¬ ê°€ê¸° ì‹«ë‹¤, íœ´ê°€ ê°€ê³  ì‹¶ì–´" â†’ ê°ì • í‘œí˜„ (therapy_tool)
     * "ì ì‹¬ ë©”ë‰´ ì¶”ì²œí•´ì¤˜" â†’ ì¼ë°˜ ëŒ€í™” (chatbot_tool)

3. **brainstorming_tool**: ì°½ì˜ì  ì•„ì´ë””ì–´ ë°œìƒ ë° ë¸Œë ˆì¸ìŠ¤í† ë° ì§€ì›
   - ì‚¬ìš© ì¡°ê±´:
     * ì‚¬ìš©ìê°€ êµ¬ì²´ì ì¸ ì•„ì´ë””ì–´ë‚˜ í•´ê²°ì±…ì„ í•„ìš”ë¡œ í•˜ëŠ” ìƒí™©
     * ë‹¨ìˆœí•œ ì •ë³´ ì§ˆë¬¸ì´ ì•„ë‹Œ, ì‹¤ì œë¡œ ì•„ì´ë””ì–´ ìƒì„±ì„ ì›í•˜ëŠ” ê²½ìš°
     * "ë¸Œë ˆì¸ìŠ¤í† ë°ì´ ë­ì•¼?" ê°™ì€ ê°œë… ì„¤ëª… ìš”ì²­ì€ chatbot_tool ì‚¬ìš©
   - íŠ¸ë¦¬ê±° ìƒí™©:
     * ëª…ì‹œì  ìš”ì²­: "ë¸Œë ˆì¸ìŠ¤í† ë° í•´ì¤˜", "ì•„ì´ë””ì–´ ë§Œë“¤ì–´ì¤˜", "ê¸°íš ë„ì™€ì¤˜"
     * ë§‰íŒ ìƒí™©: "ì¢‹ì€ ìƒê°ì´ ì•ˆ ë– ì˜¬ë¼", "ê¸°íšì´ ë§‰í˜”ì–´", "ì•„ì´ë””ì–´ê°€ í•„ìš”í•´"
     * ì°½ì˜ì  ìš”êµ¬: "ìƒˆë¡œìš´ ë°©ë²•ì´ í•„ìš”í•´", "ì°¸ì‹ í•œ ì•„ì´ë””ì–´ ì¢€", "í˜ì‹ ì ì¸ ì ‘ê·¼ë²•"
   - ì˜ˆì‹œ (ë„êµ¬ ì‚¬ìš© O):
     * "ìƒˆë¡œìš´ ë§ˆì¼€íŒ… ì•„ì´ë””ì–´ë¥¼ ë‚´ê³  ì‹¶ì–´"
     * "í”„ë¡œì íŠ¸ ê¸°íšì´ ë§‰í˜”ëŠ”ë° ë„ì™€ì¤˜"
     * "ì¢‹ì€ ìƒê°ì´ ì•ˆ ë– ì˜¬ë¼"
     * "ë¸Œë ˆì¸ìŠ¤í† ë° í•´ì¤˜"
     * "ì°½ì˜ì ì¸ í•´ê²°ì±…ì´ í•„ìš”í•´"
   - ì˜ˆì‹œ (ë„êµ¬ ì‚¬ìš© X - chatbot_tool ì‚¬ìš©):
     * "ë¸Œë ˆì¸ìŠ¤í† ë°ì´ ë­ì•¼?" â†’ ê°œë… ì„¤ëª… ìš”ì²­
     * "ì•„ì´ë””ì–´ë¥¼ ë§Œë“ ë‹¤ëŠ” ê²Œ ë­ì•¼?" â†’ ì •ë³´ ì§ˆë¬¸
     * "ë¸Œë ˆì¸ìŠ¤í† ë° ë°©ë²• ì•Œë ¤ì¤˜" â†’ ê¸°ë²• ì„¤ëª… ìš”ì²­

4. **planner_tool**: ì¼ì • ê´€ë¦¬, ê³„íš ìˆ˜ë¦½
   - í‚¤ì›Œë“œ: ì¼ì •, ê³„íš, ìŠ¤ì¼€ì¤„, í•  ì¼, ì—…ë¬´, ì‘ì—…, ì •ë¦¬, ê´€ë¦¬, ì‹œê°„, ì˜¤ëŠ˜, ë‚´ì¼, ì´ë²ˆ ì£¼, ë‹¤ìŒ ì£¼, ìš°ì„ ìˆœìœ„, ë§ˆê°, ë°ë“œë¼ì¸, ëª©í‘œ, ìƒì‚°ì„±, íš¨ìœ¨, íƒ€ì„ë¼ì¸, ì¼ê³¼
   - ì˜ˆì‹œ: "ì˜¤ëŠ˜ í•  ì¼ì„ ì •ë¦¬í•´ì¤˜", "ì¼ì • ê´€ë¦¬ ë°©ë²• ì•Œë ¤ì¤˜", "ì—…ë¬´ ìš°ì„ ìˆœìœ„ ì •í•˜ëŠ” ë²•"

5. **report_tool**: ë¦¬í¬íŠ¸ ìƒì„±, ì‹¤ì  ë¶„ì„
   - í‚¤ì›Œë“œ: ë¦¬í¬íŠ¸, ë³´ê³ ì„œ, ì‹¤ì , ì„±ê³¼, ë¶„ì„, í†µê³„, ë°ì´í„°, ê²°ê³¼, í‰ê°€, ì§€í‘œ, KPI, ë§¤ì¶œ, ìˆ˜ì¹˜, ì¶”ì´, íŠ¸ë Œë“œ, ìš”ì•½, ì •ë¦¬, ì¼ê°„, ì£¼ê°„, ì›”ê°„, ë¶„ê¸°, ì—°ê°„
   - ì˜ˆì‹œ: "ì´ë²ˆ ì£¼ ì‹¤ì ì„ ë¶„ì„í•´ì¤˜", "ì›”ê°„ ë¦¬í¬íŠ¸ ì‘ì„±í•´ì¤˜", "ì„±ê³¼ í‰ê°€ ìë£Œ ë§Œë“¤ì–´ì¤˜"

6. **therapy_tool**: ì‹¬ë¦¬ ìƒë‹´, ì •ì‹  ê±´ê°• ì§€ì›
   - í‚¤ì›Œë“œ: 
     * ê¸°ë³¸ ê°ì •: í˜ë“¤ì–´, ìƒë‹´, ì§œì¦, ìš°ìš¸, ë¶ˆì•ˆ, ìŠ¤íŠ¸ë ˆìŠ¤, ê³ ë¯¼, ê±±ì •, ìŠ¬í”„, ì™¸ë¡œ, í™”ë‚˜, ë‹µë‹µ, ì‹¬ë¦¬, ì•„ë“¤ëŸ¬, ìŠ¬í¼, ìŠ¬í”„ë‹¤
     * ë¶€ì •ì  ê°ì •: ì ˆë§, í¬ê¸°, ë¬´ê¸°ë ¥, ìì±…, í›„íšŒ, ë¯¸ì•ˆ, ë‘ë ¤ì›€, ê³µí¬, ë¶ˆì•ˆê°, ì´ˆì¡°, ë¶„ë…¸, í™”ë‚¨, ì§œì¦ë‚˜, ì„±ê°€ì‹¬, ë¶ˆì¾Œ, ìŠ¬í””, ë¹„ì°¸, ì ˆë§ì , ìš°ìš¸í•¨, ì¹¨ì²´, ì™¸ë¡œì›€, ê³ ë…, ì“¸ì“¸, í—ˆì „, ì™¸í†¨ì´, ë‹µë‹µí•¨, ë§‰ë§‰, ë‚œì²˜, ê³¤ë€, í”¼ê³¤, ì§€ì¹¨, ë¬´ë ¥ê°, ì˜ìš•ì—†ìŒ, ìˆ˜ì¹˜, ìˆ˜ì¹˜ì‹¬, ì—´ë°›, ì—´ë°›ì•„, í™”ë‚¼, ë¯¸ì¹˜, ë¯¸ì³, ì–µìš¸, ì–µìš¸í•´, ë©í•˜
     * ê´€ê³„/ëŒ€ì¸ê´€ê³„: ê°ˆë“±, ì‹¸ì›€, ë‹¤íˆ¼, ì˜¤í•´, ë¶ˆí™”, ì´ë³„, í—¤ì–´ì§, ì´í˜¼, ê²°ë³„, ë°°ì‹ , ìƒì²˜, ì•„í””, ì„œìš´, ì†Œì™¸, ì™•ë”°, ë”°ëŒë¦¼, ë¬´ì‹œ, ë°°ì œ, ë©€ë¦¬í•˜ëŠ”, ë”°ë¡œ ë…¸ëŠ”, ê²‰ëŒê³ , í˜¼ì, ë‚¨ê²¨ì§€ëŠ”, ë¶ˆí¸
     * ì§ì¥/í•™ì—… ìŠ¤íŠ¸ë ˆìŠ¤: ì§ì¥, ì—…ë¬´, ê³¼ë¡œ, ë²ˆì•„ì›ƒ, ì‹œí—˜, ê³µë¶€, í•™ì—…, ì„±ì , ì••ë°•, ì‹¤íŒ¨, ì¢Œì ˆ, ë‚™ë‹´, ì‹¤ë§, ìƒì‚¬, íŒ€ì¥, ë¶€ì¥, ë™ê¸°, ë™ë£Œ, ìš•, ìŒìš•, í­ì–¸, ì¸ê²©ëª¨ë…, ì†Œë¦¬ì§€ë¥´, í™”í’€ì´, ê·¸ë§Œë‘, í‡´ì‚¬, ì‚¬ì§, ì ì‘, ë¶„ìœ„ê¸°, ë¬¸í™”, ìµìˆ™, ë¶€ë‹´, ì–´ìš¸ë¦¬, ì†Œí†µ, í™˜ê²½, ì¶œê·¼, ë…¸ë ¥, ê¸´ì¥, ë‚¯ì„¤, ëŒ€í™”, ê·œì¹™, ì ˆì°¨, ë³µì¡, ì‹œìŠ¤í…œ, íš¨ìœ¨, íšŒì˜, ì˜ê²¬, í‘œí˜„, ì¶œí‡´ê·¼, ë£¨í‹´, ë¦¬ë“¬, ë³€í™”, ë¶€ë‹´ê°, í”„ë¡œì íŠ¸
     * ìê¸°ì¡´ì¤‘ê°: ìì¡´ê°, ìì‹ ê°, ì—´ë“±ê°, ë¹„êµ, ì—´ë“±, ìê¸°ë¹„í•˜, ìê¸°í˜ì˜¤, ë¶€ì¡±í•¨, ëŠ¥ë ¥ë¶€ì¡±, ë¬´ëŠ¥ë ¥, ì“¸ëª¨ì—†ìŒ
     * íŠ¸ë¼ìš°ë§ˆ: íŠ¸ë¼ìš°ë§ˆ, ìƒì²˜, ê³¼ê±°, ê¸°ì–µ, ì•…ëª½, í”Œë˜ì‹œë°±, ptsd
     * ì‹ ì²´ ë°˜ì‘: ì‹¬ì¥, ë–¨ë ¤, ë–¨ë¦¼, ì†ë–¨ë¦¼, ì ì´ ì•ˆ ì™€, ë¶ˆë©´, ìˆ˜ë©´ì¥ì• , ìˆ˜ë©´
     * ê°ì • ì¡°ì ˆ: ê°ì •ì¡°ì ˆ, ê°ì • ì¡°ì ˆ, í¼ë¶“, í¼ë¶“ë‹¤, ëŒ€ì²˜, í˜„ëª…, í•´ê²°
     * ìì‚´ ì‚¬ê³ : ì£½ê³  ì‹¶, ìì‚´, ìì‚´ì‚¬ê³ 
     * ìƒë‹´/ì¹˜ë£Œ: ì‹¬ë¦¬ìƒë‹´, ì •ì‹ ê±´ê°•, ì¹˜ë£Œ, ì¹˜ìœ , íšŒë³µ, ë§ˆìŒ, ê°ì •, ê¸°ë¶„, ìƒíƒœ, ì¡°ì–¸, ë„ì›€, ì§€ì›, ìœ„ë¡œ, ê²©ë ¤, ê³µê°
     * ì¼ìƒì  í‘œí˜„: ì•ˆì¢‹ì•„, ì•ˆì¢‹ìŒ, ë‚˜ì¨, ìµœì•…, ë”ì°, ê´´ë¡œì›Œ, ê´´ë¡­, ì•„íŒŒ, ì•„í””, ê³ í†µ, í˜ë“¦, ì–´ë ¤ì›€, ë‚œê°, ë§‰ë§‰í•¨
     * ì˜ì–´: counseling, therapy, help, depressed, anxious, sad, angry, lonely, frustrated, stressed, worried, scared, afraid, fear, panic, hopeless, helpless, worthless, empty, guilt, shame, regret, remorse, jealous, envy, tired, exhausted, burnout, overwhelmed, confused, lost, psychology, mental health, counselor, therapist, support, comfort, encouragement, empathy, trauma, alcoholic, drunk, abusive, violence, trust, mistrust, trustworthy, parent, family, perfect, perfectionism, insecure, instability, inflexible, overbearing, control
   - ì˜ˆì‹œ: "ìŠ¤íŠ¸ë ˆìŠ¤ê°€ ë§ì•„ì„œ í˜ë“¤ì–´", "ìš°ìš¸í•œ ê¸°ë¶„ì´ ë“¤ì–´", "ëŒ€ì¸ê´€ê³„ ë¬¸ì œë¡œ ê³ ë¯¼ì´ì•¼", "ë²ˆì•„ì›ƒì´ ì™€", "ìƒì‚¬ê°€ ë¬´ì„œì›Œ", "ìì¡´ê°ì´ ë‚®ì•„", "íŠ¸ë¼ìš°ë§ˆê°€ ìˆì–´"

7. **notion_tool**: Notion í˜ì´ì§€ ê´€ë¦¬ (ê²€ìƒ‰, ìƒì„±, ëŒ€í™” ë‚´ìš© ì €ì¥)
   - **í•µì‹¬ ì˜ë„**: ì‚¬ìš©ìê°€ Notionì— ë¬´ì–¸ê°€ë¥¼ **ì €ì¥, ê¸°ë¡, ë©”ëª¨**í•˜ê±°ë‚˜, ê¸°ì¡´ í˜ì´ì§€ë¥¼ **ê²€ìƒ‰, ì¡°íšŒ, ìˆ˜ì •**í•˜ë ¤ëŠ” ê²½ìš°
   - **ì‚¬ìš© ì¡°ê±´**:
     * ì‚¬ìš©ìê°€ Notionì— **ì‹¤ì œë¡œ í˜ì´ì§€ë¥¼ ë§Œë“¤ê±°ë‚˜ ë‚´ìš©ì„ ì €ì¥**í•˜ë ¤ëŠ” ëª…í™•í•œ ì˜ë„ê°€ ìˆì„ ë•Œ
     * "ë…¸ì…˜", "notion", "í˜ì´ì§€" ë‹¨ì–´ì™€ í•¨ê»˜ **í–‰ë™ ë™ì‚¬**(ë§Œë“¤ì–´, ì €ì¥, ì ì–´, ê¸°ë¡ ë“±)ê°€ ìˆì„ ë•Œ
     * ëŒ€í™” ë‚´ìš©ì„ ì •ë¦¬í•´ì„œ ë³´ê´€í•˜ê³  ì‹¶ì„ ë•Œ
   - **íŠ¸ë¦¬ê±° ìƒí™©**:
     * í˜ì´ì§€ ìƒì„±: "X í˜ì´ì§€ ë§Œë“¤ì–´ì¤˜", "Xë¼ëŠ” í˜ì´ì§€ ìƒì„±í•´ì¤˜"
     * ë‚´ìš© ì‘ì„±: "Xë¼ê³  ì ì–´ì¤˜", "ì œëª©ì€ X, ë‚´ìš©ì€ Yë¡œ ë§Œë“¤ì–´ì¤˜"
     * ëŒ€í™” ì €ì¥: "ìƒë‹´ ë‚´ìš© ë…¸ì…˜ì— ì €ì¥í•´ì¤˜", "ì´ê±° ì •ë¦¬í•´ì„œ ë…¸ì…˜ì— ì˜¬ë ¤ì¤˜"
     * í˜ì´ì§€ ê²€ìƒ‰: "ë…¸ì…˜ì—ì„œ X ì°¾ì•„ì¤˜", "X í˜ì´ì§€ ì–´ë”” ìˆì–´?"
   - **ì˜ˆì‹œ (notion_tool ì‚¬ìš© O)**:
     * âœ… "ì•ˆë…•ì´ë¼ëŠ” í˜ì´ì§€ ë§Œë“¤ê³  ì˜¤ëŠ˜ í• ì¼ ëª©ë¡ ë‹¤ì´ì†Œ ë“¤ë¦¬ê¸° ë¼ê³  ì ì–´ì¤˜"
       â†’ ì œëª©: "ì•ˆë…•", ë‚´ìš©: "ì˜¤ëŠ˜ í• ì¼ ëª©ë¡ ë‹¤ì´ì†Œ ë“¤ë¦¬ê¸°"
     * âœ… "ë‚´ ë…¸ì…˜ì— ì œëª©ì€ ì•ˆë…•, ë‚´ìš©ì€ í´ë ˆì˜¤íŒŒíŠ¸ë¼ ë¼ê³  ì ì–´ì¤˜"
       â†’ ì œëª©: "ì•ˆë…•", ë‚´ìš©: "í´ë ˆì˜¤íŒŒíŠ¸ë¼"
     * âœ… "ê°œì¸ í˜ì´ì§€ì— 'íšŒì˜ë¡'ì´ë¼ê³  ì ì–´ì¤˜"
   - ì˜ˆ: "ì œëª©ì€ X, ë‚´ìš©ì€ Yë¡œ ì ì–´ì¤˜" â†’ notion_tool
   - ì˜ˆ: "ìƒë‹´ ë‚´ìš© ë…¸ì…˜ì— ì €ì¥í•´ì¤˜" â†’ notion_tool
   - ì˜ˆ: "ë°©ê¸ˆ ë‹µë³€í•´ì¤€ ë‚´ìš© ë…¸ì…˜ì— ì •ë¦¬í•´ì„œ ë„£ì–´ì¤˜" â†’ notion_tool
   - ì˜ˆ: "ì œíœ´ì‚¬ ëª©ë¡ í˜ì´ì§€ ë§Œë“¤ì–´ì„œ ì •ë¦¬í•´ì¤˜" â†’ notion_tool
   - ì˜ˆ: "ë…¸ì…˜ì— ìˆëŠ” AIì§ì—…ì¢…ë¥˜ ë‚´ìš© ì•Œë ¤ì¤˜" â†’ notion_tool
   - ì˜ˆ: "í˜ì´ì§€ ì°¾ì•„ì¤˜" â†’ notion_tool

8. **"ë©”ì¼", "ì´ë©”ì¼"** ê´€ë ¨ ìš”ì²­(ì „ì†¡, ê²€ìƒ‰, ì²¨ë¶€) â†’ **ë¬´ì¡°ê±´ email_tool**
   - ì˜ˆ: "ì´ê±° ë©”ì¼ë¡œ ë³´ë‚´ì¤˜" â†’ email_tool
   - ì˜ˆ: "ì•ˆ ì½ì€ ë©”ì¼ ìˆì–´?" â†’ email_tool

9. **insurance_tool**: ë³´í—˜ ìƒí’ˆ ë° ì²­êµ¬ ê´€ë ¨ ìƒë‹´
   - **í•µì‹¬ ì˜ë„**: ì‚¬ìš©ìê°€ ë³´í—˜ ìƒí’ˆ, ë³´í—˜ê¸ˆ ì²­êµ¬, ë³´í—˜ ê·œì •, ì²­êµ¬ ì ˆì°¨ ë“±ì— ëŒ€í•´ **ì •ë³´ë¥¼ ì›í•˜ê±°ë‚˜ ìƒë‹´ì„ í•„ìš”ë¡œ í•˜ëŠ” ê²½ìš°**
   - **ì‚¬ìš© ì¡°ê±´**:
     * ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— "ë³´í—˜", "ë³´í—˜ê¸ˆ", "ì²­êµ¬", "ë³´ì¥", "íŠ¹ì•½", "ì•½ê´€", "ë³´í—˜ë£Œ", "ë§Œê¸°", "í™˜ê¸‰" ë“±ì˜ í‚¤ì›Œë“œê°€ í¬í•¨ë  ë•Œ
     * ë³´í—˜ ìƒí’ˆ ì„¤ëª…, ì²­êµ¬ ì ˆì°¨, ë³´í—˜ê¸ˆ ê³„ì‚°, ê·œì • í™•ì¸ì´ í•„ìš”í•œ ê²½ìš°
     * ê°œì¸ì˜ ë³´í—˜ ê°€ì… ìƒí™©ì— ëŒ€í•œ êµ¬ì²´ì ì¸ ìƒë‹´ì´ í•„ìš”í•œ ê²½ìš°
   - **íŠ¸ë¦¬ê±° ìƒí™©**:
     * ë³´í—˜ ìƒí’ˆ ë¬¸ì˜: "ì˜ë£Œë³´í—˜ì´ ë­ì˜ˆìš”?", "ì–´ë–¤ ë³´í—˜ ìƒí’ˆì´ ìˆë‚˜ìš”?", "ì•”ë³´í—˜ê³¼ ì¢…ì‹ ë³´í—˜ì˜ ì°¨ì´ëŠ”?"
     * ì²­êµ¬ ì ˆì°¨: "ë³´í—˜ê¸ˆ ì²­êµ¬í•˜ëŠ” ë°©ë²•ì´ ë­ì˜ˆìš”?", "ì²­êµ¬ì— í•„ìš”í•œ ì„œë¥˜ëŠ”?", "ì²­êµ¬ ì ˆì°¨ê°€ ë³µì¡í•´ìš”"
     * ë³´í—˜ê¸ˆ ê´€ë ¨: "ë³´í—˜ê¸ˆì´ ë‚˜ì˜¬ê¹Œìš”?", "ë³´ì¥ ë²”ìœ„ê°€ ë­ì˜ˆìš”?", "ë³´í—˜ê¸ˆ ê³„ì‚° ì–´ë–»ê²Œ ë˜ë‚˜ìš”?"
     * ë³´í—˜ë£Œ/í˜œíƒ: "ë³´í—˜ë£ŒëŠ” ì–¼ë§ˆë‚˜ ë˜ë‚˜ìš”?", "ì›”ë‚©ê¸ˆ í™˜ê¸‰ì´ ë˜ë‚˜ìš”?", "ë§Œê¸° í™˜ê¸‰ê¸ˆì€?"
     * ê·œì •/ì•½ê´€: "íŠ¹ì•½ì´ ë­ì˜ˆìš”?", "ë³´í—˜ì•½ê´€ ì–´ë””ì„œ ë´ìš”?", "ë³´í—˜ ê°€ì… ì¡°ê±´ì´ ë­ì˜ˆìš”?"
   - **ì˜ˆì‹œ (insurance_tool ì‚¬ìš© O)**:
     * âœ… "ì˜ë£Œê¸‰ì—¬ë¥¼ ë°›ì„ ì¡°ê±´ì´ ë­ì˜ˆìš”?"
     * âœ… "ë³´í—˜ê¸ˆ ì²­êµ¬í•˜ëŠ” ë°©ë²• ì•Œë ¤ì¤˜"
     * âœ… "ì†í•´ë°°ìƒ ì²­êµ¬ ì ˆì°¨ëŠ”?"
     * âœ… "ë³´í—˜ì—ì„œ ë³´ì¥í•˜ëŠ” ë²”ìœ„ê°€ ë­ì˜ˆìš”?"
     * âœ… "ë³´í—˜ê¸ˆì´ ë‚˜ì˜¬ê¹Œìš”?"
   - **ì˜ˆì‹œ (insurance_tool ì‚¬ìš© X - ë‹¤ë¥¸ ë„êµ¬ ì‚¬ìš©)**:
     * âŒ "ë³´í—˜ì´ ë­ì˜ˆìš”?" â†’ ì¼ë°˜ ìƒì‹ (chatbot_tool)
     * âŒ "ë³´í—˜ ê°€ì…í•˜ë ¤ëŠ”ë° ìŠ¤íŠ¸ë ˆìŠ¤ë°›ì•„" â†’ ê°ì • í‘œí˜„ (therapy_tool)
     * âŒ "ë³´í—˜ ê³„íšì„ ì„¸ì›Œì•¼ í•´" â†’ ê³„íš ìˆ˜ë¦½ (planner_tool)

# 3. **'ë³´í—˜', 'ë³´í—˜ê¸ˆ', 'ì²­êµ¬'** ê´€ë ¨ ë¬¸ì˜ â†’ **ë¬´ì¡°ê±´ insurance_tool**

# 3. **"ë¸Œë ˆì¸ìŠ¤í† ë°"** ë‹¨ì–´ê°€ ëª…ì‹œì ìœ¼ë¡œ í¬í•¨ â†’ **ë¬´ì¡°ê±´ brainstorming_tool**

# 3. **ê°ì • í‘œí˜„** (í˜ë“¤ì–´, ìš°ìš¸í•´, ìŠ¤íŠ¸ë ˆìŠ¤ ë“±) â†’ **therapy_tool ìš°ì„ **

**ğŸŸ¡ ì¼ë°˜ ê·œì¹™:**
10. íšŒì‚¬ ê·œì •/ì •ì±…/ë¬¸ì„œ ê²€ìƒ‰ â†’ rag_tool
11. ì¼ì •/ê³„íš ê´€ë¦¬ â†’ planner_tool
12. ë¦¬í¬íŠ¸/ì‹¤ì  ë¶„ì„ â†’ report_tool
13. ë©”ì¼ ì „ì†¡, ê²€ìƒ‰, ì²¨ë¶€ â†’ email_tool
14. ì¼ë°˜ ëŒ€í™”/ì¸ì‚¬/ì¡ë‹´ â†’ chatbot_tool

**ì¤‘ìš”í•œ ê·œì¹™:**
- **ì‚¬ìš©ìì˜ ì˜ë„ë¥¼ ì •í™•íˆ íŒŒì•…í•˜ëŠ” ê²ƒì´ ìµœìš°ì„ ì…ë‹ˆë‹¤.**
- **í–‰ë™ ë™ì‚¬**(ë§Œë“¤ì–´, ì €ì¥, ì ì–´, ê¸°ë¡, ìƒì„± ë“±)ê°€ ìˆìœ¼ë©´ **ì‹¤í–‰ ì˜ë„**ì…ë‹ˆë‹¤.
- **ì§ˆë¬¸ ë™ì‚¬**(ë­ì•¼, ì–´ë–»ê²Œ, ì•Œë ¤ì¤˜ ë“±)ë§Œ ìˆìœ¼ë©´ **ì •ë³´ ìš”ì²­**ì…ë‹ˆë‹¤.

**ì˜ë„ íŒë³„ ì˜ˆì‹œ:**
- âœ… "ì•ˆë…•ì´ë¼ëŠ” í˜ì´ì§€ ë§Œë“¤ì–´ì¤˜" â†’ **ì‹¤í–‰ ì˜ë„** â†’ notion_tool
- âŒ "í˜ì´ì§€ ë§Œë“œëŠ” ë°©ë²• ì•Œë ¤ì¤˜" â†’ **ì •ë³´ ìš”ì²­** â†’ chatbot_tool
- âœ… "ì œëª©ì€ X, ë‚´ìš©ì€ Yë¡œ ì ì–´ì¤˜" â†’ **ì‹¤í–‰ ì˜ë„** â†’ notion_tool
- âŒ "ë…¸ì…˜ì´ ë­ì•¼?" â†’ **ì •ë³´ ìš”ì²­** â†’ chatbot_tool
- âœ… "ìƒë‹´ ë‚´ìš© ì €ì¥í•´ì¤˜" â†’ **ì‹¤í–‰ ì˜ë„** â†’ notion_tool
- âŒ "ì €ì¥í•˜ëŠ” ë°©ë²• ì•Œë ¤ì¤˜" â†’ **ì •ë³´ ìš”ì²­** â†’ chatbot_tool

**ìµœì¢… ì²´í¬:**
- ê°€ì¥ ì í•©í•œ ì—ì´ì „íŠ¸ **í•˜ë‚˜ë§Œ** ì„ íƒí•˜ì„¸ìš”.
- **brainstorming_toolì„ ì„ íƒí•œ ê²½ìš°, ì ˆëŒ€ ì§ì ‘ ë‹µë³€ì„ ìƒì„±í•˜ì§€ ë§ê³  ì—ì´ì „íŠ¸ì˜ ì•ˆë‚´ ë©”ì‹œì§€ë§Œ ê·¸ëŒ€ë¡œ ì „ë‹¬í•˜ì„¸ìš”.**
- **ì ì ˆí•œ ì—ì´ì „íŠ¸(ë„êµ¬)ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ì±—ë´‡ì´ ì§ì ‘ ê¸¸ê²Œ ì„¤ëª…í•˜ì§€ ë§ê³  ê°„ê²°í•˜ê²Œ í•´ë‹¹ ëª¨ë“ˆ ì‚¬ìš©ì„ ì•ˆë‚´í•˜ì„¸ìš”.**
- ì—ì´ì „íŠ¸ì˜ ì‘ë‹µì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©ìì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”.
- í•œêµ­ì–´ë¡œ ì‘ë‹µí•˜ì„¸ìš”.
"""
        
        return system_message
    
    # ì‚¬ìš©ì ì§ˆë¬¸ì„ ì²˜ë¦¬í•˜ëŠ” ë¹„ë™ê¸° í•¨ìˆ˜
    async def process(self, request: MultiAgentRequest) -> MultiAgentResponse:

        start_time = time.time()
        
        try:
            # Context ì„¤ì • (ContextVars ì‚¬ìš©)
            session_context.set(request.session_id)
            
            # ì‚¬ìš©ì ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±
            current_user_context = request.context or {}
            if request.user_id:
                current_user_context["user_id"] = request.user_id
            user_context.set(current_user_context)
            
            # LangGraph Agent ì‹¤í–‰
            result = await self.agent_executor.ainvoke({
                "messages": [HumanMessage(content=request.query)]
            })
            
            # ê²°ê³¼ ì¶”ì¶œ (LangGraphëŠ” messages í˜•íƒœë¡œ ë°˜í™˜)
            messages = result.get("messages", [])
            answer = "ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            agent_used = "supervisor"
            
            # ë§ˆì§€ë§‰ AI ë©”ì‹œì§€ì—ì„œ ë‹µë³€ ì¶”ì¶œ
            for msg in reversed(messages):
                if hasattr(msg, 'content') and msg.content:
                    answer = msg.content
                    break
            
            # ì‚¬ìš©ëœ ë„êµ¬ ì¶”ì¶œ
            intermediate_steps = []
            for msg in messages:
                if hasattr(msg, 'tool_calls') and msg.tool_calls:
                    for tool_call in msg.tool_calls:
                        tool_name = tool_call.get('name', 'unknown')
                        agent_used = tool_name.replace('_tool', '')
                        intermediate_steps.append({
                            "agent": agent_used,
                            "action": "process_query",
                            "result": "success"
                        })
            
            # ì²˜ë¦¬ ì‹œê°„ ê³„ì‚°
            processing_time = time.time() - start_time
            
            # ì‘ë‹µ ìƒì„±
            response = MultiAgentResponse(
                query=request.query,
                answer=answer,
                agent_used=agent_used,
                intermediate_steps=intermediate_steps if intermediate_steps else [
                    {
                        "agent": agent_used,
                        "action": "process_query",
                        "result": "success"
                    }
                ],
                processing_time=processing_time,
                session_id=request.session_id
            )
            
            # ì„¸ì…˜ì— ëŒ€í™” ë‚´ìš© ì €ì¥
            if request.session_id:
                try:
                    from app.domain.chatbot.session_manager import SessionManager
                    from app.domain.chatbot.memory_manager import MemoryManager
                    
                    session_manager = SessionManager()
                    memory_manager = MemoryManager()
                    
                    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                    
                    # ì‚¬ìš©ì ì§ˆë¬¸ ì €ì¥
                    session_manager.add_message(request.session_id, "user", request.query)
                    memory_manager.append_message(request.session_id, {
                        "role": "user",
                        "content": request.query,
                        "timestamp": timestamp
                    })
                    
                    # AI ë‹µë³€ ì €ì¥
                    session_manager.add_message(request.session_id, "assistant", answer)
                    memory_manager.append_message(request.session_id, {
                        "role": "assistant",
                        "content": answer,
                        "timestamp": timestamp,
                        "agent_used": agent_used
                    })
                    
                except Exception as e:
                    print(f"[ERROR] ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨: {e}")
            
            return response
            
        # ì˜¤ë¥˜ ì²˜ë¦¬
        except Exception as e:
            
            processing_time = time.time() - start_time
            error_message = f"ì§ˆë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤"
            
            return MultiAgentResponse(
                query=request.query,
                answer=error_message,
                agent_used="error",
                intermediate_steps=[
                    {
                        "agent": "supervisor",
                        "action": "error",
                        "error": str(e)
                    }
                ],
                processing_time=processing_time,
                session_id=request.session_id
            )
            
        finally:
            # ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™”
            reset_context()
    
    # ì‚¬ìš© ê°€ëŠ¥í•œ ì—ì´ì „íŠ¸ ëª©ë¡ ë°˜í™˜
    def get_available_agents(self) -> List[Dict[str, Any]]:

        agents = []
        
        # ì—ì´ì „íŠ¸ ëª©ë¡ì— ì´ë¦„ì´ë‘ ì„¤ëª… ì¶”ê°€
        for tool in self.tools:
            agents.append({
                "name": tool.name,
                "description": tool.description,
            })
        
        return agents

